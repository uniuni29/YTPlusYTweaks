name: Build .deb packages

on:
  workflow_dispatch:
    inputs:

      enable_youpip:
        description: "Build YouPiP"
        type: boolean
        required: true
        default: true

      enable_ytuhd:
        description: "Build YTUHD"
        type: boolean
        required: true
        default: true

      enable_yq:
        description: "Build YouQuality"
        type: boolean
        required: true
        default: true

      enable_ryd:
        description: "Build Return YouTube Dislikes"
        type: boolean
        required: true
        default: true

      enable_demc:
        description: "Build DontEatMyContent"
        type: boolean
        required: true
        default: true

      enable_ytabconfig:
        description: "Build YTABConfig"
        type: boolean
        required: true
        default: true

      enable_ytweaks:
        description: "Build YTweaks"
        type: boolean
        required: true
        default: true

      enable_yticons:
        description: "Build YTIcons"
        type: boolean
        required: true
        default: false

      enable_gonerino:
        description: "Build Gonerino"
        type: boolean
        required: true
        default: false

      enable_yougroupsettings:
        description: "Build YouGroupSettings"
        type: boolean
        required: true
        default: true

      tweak_version:
        description: "The version of YTLite to use. E.g. 5.2b3 (optional - leave empty to use latest tag from github.com/dayanch96/YTLite/tags)"
        default: ""
        required: false
        type: string

      sdk_version:
        description: "iOS SDK Version"
        type: choice
        options:
          - 16.5
          - 17.5
          - 18.6
        required: true
        default: 16.5

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: 
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4.1.1
        with:
          #path: main
          submodules: recursive
      
      - name: Check version
        uses: ./.github/actions/check-version

      - name: Install dependencies
        run: brew install make ldid

      - name: Set PATH environment variable
        run: echo "$(brew --prefix make)/libexec/gnubin" >> $GITHUB_PATH

      - name: Check if any tweaks are enabled
        id: check_tweaks
        run: |
          if [ "${{ inputs.enable_youpip }}" = "true" ] || \
             [ "${{ inputs.enable_ytuhd }}" = "true" ] || \
             [ "${{ inputs.enable_yq }}" = "true" ] || \
             [ "${{ inputs.enable_ryd }}" = "true" ] || \
             [ "${{ inputs.enable_demc }}" = "true" ] || \
             [ "${{ inputs.enable_ytabconfig }}" = "true" ] || \
             [ "${{ inputs.enable_ytweaks }}" = "true" ] || \
             [ "${{ inputs.enable_yticons }}" = "true" ] || \
             [ "${{ inputs.enable_yougroupsettings }}" = "true" ] || \
             [ "${{ inputs.enable_gonerino }}" = "true" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "Tweaks are enabled"
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "No tweaks enabled"
          fi

      - name: Get commit hashes
        id: commit_hashes
        uses: ./.github/actions/get-commit-hashes
        with:
          enable_youpip: ${{ steps.check_tweaks.outputs.enabled == 'true' && inputs.enable_youpip || 'false' }}
          enable_ytuhd: ${{ steps.check_tweaks.outputs.enabled == 'true' && inputs.enable_ytuhd || 'false' }}
          enable_ryd: ${{ steps.check_tweaks.outputs.enabled == 'true' && inputs.enable_ryd || 'false' }}
          enable_yougroupsettings: ${{ steps.check_tweaks.outputs.enabled == 'true' && inputs.enable_yougroupsettings || 'false' }}
          enable_yq: ${{ steps.check_tweaks.outputs.enabled == 'true' && inputs.enable_yq || 'false' }}
          enable_ytabconfig: ${{ steps.check_tweaks.outputs.enabled == 'true' && inputs.enable_ytabconfig || 'false' }}
          enable_ytweaks: ${{ steps.check_tweaks.outputs.enabled == 'true' && inputs.enable_ytweaks || 'false' }}
          enable_yticons: ${{ steps.check_tweaks.outputs.enabled == 'true' && inputs.enable_yticons || 'false' }}
          enable_demc: ${{ steps.check_tweaks.outputs.enabled == 'true' && inputs.enable_demc || 'false' }}
          enable_gonerino: ${{ steps.check_tweaks.outputs.enabled == 'true' && inputs.enable_gonerino || 'false' }}

      - name: Cache Theos
        if: steps.check_tweaks.outputs.enabled == 'true'
        id: theos
        uses: ./.github/actions/cache-theos
        with:
          sdk_version: ${{ inputs.sdk_version }}
          theos_commit: ${{ steps.commit_hashes.outputs.theos }}

      - name: Download iOS 16.5 SDK
        if: steps.check_tweaks.outputs.enabled == 'true' && inputs.sdk_version == 16.5 && steps.theos.outputs.cache-hit != 'true'
        uses: ./.github/actions/download-sdk-16.5
        with:
          theos_path: ${{ github.workspace }}/theos

      - name: Download iOS 17.5 SDK
        if: steps.check_tweaks.outputs.enabled == 'true' && inputs.sdk_version == 17.5 && steps.theos.outputs.cache-hit != 'true'
        uses: ./.github/actions/download-sdk-17.5
        with:
          theos_path: ${{ github.workspace }}/theos

      - name: Download iOS 18.6 SDK
        if: steps.check_tweaks.outputs.enabled == 'true' && inputs.sdk_version == 18.6 && steps.theos.outputs.cache-hit != 'true'
        uses: ./.github/actions/download-sdk-18.6
        with:
          theos_path: ${{ github.workspace }}/theos

      - name: Get YTLite release
        id: ytlite_version
        uses: ./.github/actions/get-YTLite
        with:
          tweak_version: ${{ inputs.tweak_version }}
          workspace: ${{ github.workspace }}
          github_token: ${{ github.token }}

      - name: Clone YouTubeHeader
        if: steps.check_tweaks.outputs.enabled == 'true'
        uses: ./.github/actions/clone-youtube-header
        with:
          theos_path: ${{ github.workspace }}/theos
          enable_demc: ${{ inputs.enable_demc }}

      - name: Clone PSHeader
        if: steps.check_tweaks.outputs.enabled == 'true'
        uses: ./.github/actions/clone-ps-header
        with:
          theos_path: ${{ github.workspace }}/theos

      - name: Cache tweaks
        if: steps.check_tweaks.outputs.enabled == 'true'
        id: cache_tweaks_step
        uses: ./.github/actions/cache-tweaks
        with:
          enable_youpip: ${{ inputs.enable_youpip }}
          enable_ytuhd: ${{ inputs.enable_ytuhd }}
          enable_ryd: ${{ inputs.enable_ryd }}
          enable_yougroupsettings: ${{ inputs.enable_yougroupsettings }}
          enable_yq: ${{ inputs.enable_yq }}
          enable_ytabconfig: ${{ inputs.enable_ytabconfig }}
          enable_ytweaks: ${{ inputs.enable_ytweaks }}
          enable_yticons: ${{ inputs.enable_yticons }}
          enable_demc: ${{ inputs.enable_demc }}
          enable_gonerino: ${{ inputs.enable_gonerino }}
          sdk_version: ${{ inputs.sdk_version }}
          youpip_commit: ${{ steps.commit_hashes.outputs.youpip }}
          ytuhd_commit: ${{ steps.commit_hashes.outputs.ytuhd }}
          ryd_commit: ${{ steps.commit_hashes.outputs.ryd }}
          ygs_commit: ${{ steps.commit_hashes.outputs.ygs }}
          yq_commit: ${{ steps.commit_hashes.outputs.yq }}
          yabc_commit: ${{ steps.commit_hashes.outputs.yabc }}
          ytwks_commit: ${{ steps.commit_hashes.outputs.ytwks }}
          yticons_commit: ${{ steps.commit_hashes.outputs.yticons }}
          demc_commit: ${{ steps.commit_hashes.outputs.demc }}
          gonerino_commit: ${{ steps.commit_hashes.outputs.gonerino }}
          ytvo_commit: ${{ steps.commit_hashes.outputs.ytvo }}

      - name: Clone tweaks
        if: steps.check_tweaks.outputs.enabled == 'true'
        uses: ./.github/actions/clone-tweaks
        with:
          enable_youpip: ${{ inputs.enable_youpip }}
          enable_ytuhd: ${{ inputs.enable_ytuhd }}
          enable_ryd: ${{ inputs.enable_ryd }}
          enable_yougroupsettings: ${{ inputs.enable_yougroupsettings }}
          enable_yq: ${{ inputs.enable_yq }}
          enable_ytabconfig: ${{ inputs.enable_ytabconfig }}
          enable_ytweaks: ${{ inputs.enable_ytweaks }}
          enable_yticons: ${{ inputs.enable_yticons }}
          enable_demc: ${{ inputs.enable_demc }}
          enable_gonerino: ${{ inputs.enable_gonerino }}
          cache_youpip_hit: ${{ steps.cache_tweaks_step.outputs.cache_youpip_hit }}
          cache_ytuhd_hit: ${{ steps.cache_tweaks_step.outputs.cache_ytuhd_hit }}
          cache_ryd_hit: ${{ steps.cache_tweaks_step.outputs.cache_ryd_hit }}
          cache_ygs_hit: ${{ steps.cache_tweaks_step.outputs.cache_ygs_hit }}
          cache_yq_hit: ${{ steps.cache_tweaks_step.outputs.cache_yq_hit }}
          cache_yabc_hit: ${{ steps.cache_tweaks_step.outputs.cache_yabc_hit }}
          cache_ytwks_hit: ${{ steps.cache_tweaks_step.outputs.cache_ytwks_hit }}
          cache_yticons_hit: ${{ steps.cache_tweaks_step.outputs.cache_yticons_hit }}
          cache_demc_hit: ${{ steps.cache_tweaks_step.outputs.cache_demc_hit }}
          cache_gonerino_hit: ${{ steps.cache_tweaks_step.outputs.cache_gonerino_hit }}
          cache_ytvo_hit: ${{ steps.cache_tweaks_step.outputs.cache_ytvo_hit }}
          workspace: ${{ github.workspace }}

      - name: Build tweaks
        if: steps.check_tweaks.outputs.enabled == 'true'
        uses: ./.github/actions/build-tweaks
        with:
          enable_youpip: ${{ inputs.enable_youpip }}
          enable_ytuhd: ${{ inputs.enable_ytuhd }}
          enable_ryd: ${{ inputs.enable_ryd }}
          enable_yougroupsettings: ${{ inputs.enable_yougroupsettings }}
          enable_yq: ${{ inputs.enable_yq }}
          enable_ytabconfig: ${{ inputs.enable_ytabconfig }}
          enable_ytweaks: ${{ inputs.enable_ytweaks }}
          enable_yticons: ${{ inputs.enable_yticons }}
          enable_demc: ${{ inputs.enable_demc }}
          enable_gonerino: ${{ inputs.enable_gonerino }}
          cache_youpip_hit: ${{ steps.cache_tweaks_step.outputs.cache_youpip_hit }}
          cache_ytuhd_hit: ${{ steps.cache_tweaks_step.outputs.cache_ytuhd_hit }}
          cache_ryd_hit: ${{ steps.cache_tweaks_step.outputs.cache_ryd_hit }}
          cache_ygs_hit: ${{ steps.cache_tweaks_step.outputs.cache_ygs_hit }}
          cache_yq_hit: ${{ steps.cache_tweaks_step.outputs.cache_yq_hit }}
          cache_yabc_hit: ${{ steps.cache_tweaks_step.outputs.cache_yabc_hit }}
          cache_ytwks_hit: ${{ steps.cache_tweaks_step.outputs.cache_ytwks_hit }}
          cache_yticons_hit: ${{ steps.cache_tweaks_step.outputs.cache_yticons_hit }}
          cache_demc_hit: ${{ steps.cache_tweaks_step.outputs.cache_demc_hit }}
          cache_gonerino_hit: ${{ steps.cache_tweaks_step.outputs.cache_gonerino_hit }}
          cache_ytvo_hit: ${{ steps.cache_tweaks_step.outputs.cache_ytvo_hit }}
          theos_path: ${{ github.workspace }}/theos
          workspace: ${{ github.workspace }}

      - name: Collect DEB files
        run: |
          # DEB file name mappings:
          # ytplus.deb -> YTLite (YouTube Plus)
          # youpip.deb -> YouPiP
          # ytuhd.deb -> YTUHD
          # ryd.deb -> Return YouTube Dislikes
          # ygs.deb -> YouGroupSettings
          # yq.deb -> YouQuality
          # ytvo.deb -> YTVideoOverlay
          # yabc.deb -> YTABConfig
          # ytwks.deb -> YTweaks
          # yticons.deb -> YTIcons
          # demc.deb -> DontEatMyContent
          # gonerino.deb -> Gonerino
          
          cd ${{ github.workspace }}
          mkdir -p debs
          for f in *.deb; do
            if [ -f "$f" ]; then
              cp "$f" debs/
              echo "Collected: $f"
            fi
          done
          echo "Total DEB files: $(ls -1 debs/*.deb 2>/dev/null | wc -l | tr -d ' ')"

      - name: Rename DEB files
        run: |
          cd ${{ github.workspace }}/debs
          [ -f "ytplus.deb" ] && mv "ytplus.deb" "YTLite.deb"
          [ -f "youpip.deb" ] && mv "youpip.deb" "YouPiP.deb"
          [ -f "ytuhd.deb" ] && mv "ytuhd.deb" "YTUHD.deb"
          [ -f "ryd.deb" ] && mv "ryd.deb" "Return-YouTube-Dislikes.deb"
          [ -f "ygs.deb" ] && mv "ygs.deb" "YouGroupSettings.deb"
          [ -f "yq.deb" ] && mv "yq.deb" "YouQuality.deb"
          [ -f "ytvo.deb" ] && mv "ytvo.deb" "YTVideoOverlay.deb"
          [ -f "yabc.deb" ] && mv "yabc.deb" "YTABConfig.deb"
          [ -f "ytwks.deb" ] && mv "ytwks.deb" "YTweaks.deb"
          [ -f "yticons.deb" ] && mv "yticons.deb" "YTIcons.deb"
          [ -f "demc.deb" ] && mv "demc.deb" "DontEatMyContent.deb"
          [ -f "gonerino.deb" ] && mv "gonerino.deb" "Gonerino.deb"
          echo "Renamed DEB files to their full names"

      - name: Zip DEBs
        run: |
          cd ${{ github.workspace }}/debs
          zip -r ../debs.zip *.deb
          echo "Created debs.zip with all DEB files"

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v2.0.1
        with:
          tag_name: debs-${{ github.run_number }}
          name: YTPlusYTweaks_${{ steps.ytlite_version.outputs.version }}_SDK${{ inputs.sdk_version }} (${{ github.run_number }})
          files: |
            debs/*.deb
            debs.zip
          draft: true

      - name: Output Release URL
        run: |
          echo "::notice::Release available at: https://github.com/${{ github.repository }}/releases"
